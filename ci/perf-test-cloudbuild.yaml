steps:
  #
  # Creates the initial make + docker build platform
  #
  - name: ubuntu
    args:
      - bash
      - -c
      - "echo 'FROM gcr.io/cloud-builders/docker\nRUN apt-get install make\nENTRYPOINT\
        \ [\"/usr/bin/make\"]' > Dockerfile.build"
    waitFor: ['-']

  - name: gcr.io/cloud-builders/docker
    id: build-make-docker
    args: [build, -f, Dockerfile.build, -t, make-docker, .]  # we need docker and make to run everything.

  #
  # build the performance test runner
  #
  - name: gcr.io/cloud-builders/docker
    args: [build, -f, Dockerfile, -t, perf-runner, .]
    dir: build/perf-test-image
    id: build-perf
    waitFor:
      - build-make-docker

  #
  # Run the e2e tests with FeatureGates inverted compared to Stable
  #
  # Keep in sync with (the inverse of) pkg/util/runtime/features.go:featureDefaults
  - name: perf-runner
    args:
      - ${_TEST_CLUSTER_NAME}
      - ${_TEST_CLUSTER_LOCATION}
      - ${_REGISTRY}
      - ${_TEST_PROJECT_ID}
      - ${_TEST_FLEET_REPLICAS}
      - ${_TEST_AUTOMATIC_SHUTDOWN_DELAY_SEC}
      - ${_TEST_BUFFER_SIZE}
      - ${_TEST_MIN_REPLICAS}
      - ${_TEST_MAX_REPLICAS}
      - ${_TEST_DURATION}
      - ${_TEST_CLIENTS}
      - ${_TEST_INTERVAL}
    id: perf-test
    waitFor:
      - build-perf
  
substitutions:
  _TEST_CLUSTER_NAME: standard-e2e-test-cluster-1-27
  _TEST_CLUSTER_LOCATION: us-east1
  _REGISTRY: us-docker.pkg.dev/agones-images/ci
  _TEST_PROJECT_ID: gongmax-gke-dev
  _TEST_FLEET_REPLICAS: "20"
  _TEST_AUTOMATIC_SHUTDOWN_DELAY_SEC: "60"
  _TEST_BUFFER_SIZE: "20"
  _TEST_MIN_REPLICAS: "20"
  _TEST_MAX_REPLICAS: "6000"
  _TEST_DURATION: "10m"
  _TEST_CLIENTS: "50"
  _TEST_INTERVAL: "1000"
tags: [ci, 'commit-${COMMIT_SHA}']
timeout: 18000s  # 5h: 3h (e2e-wait-to-become-leader) + 1.5h (e2e timeout) + 0.5h (everything else)
queueTtl: 259200s  # 72h
options:
  machineType: E2_HIGHCPU_32
  dynamic_substitutions: true